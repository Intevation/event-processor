from intelmqmail.tableformat import build_table_format
import copy

def create_notifications(context):

    if context.directive["notification_format"] == "malware-infection":

        # Copy Substitutions from the context to this script.
        # This way we can edit the variables in this script
        # without changing the context.
        substitution_variables = copy.copy(context.substitutions)

        data_format = context.directive["event_data_format"]
        # Prepare Message in CSV-Format
        formats = (
            ("source.asn", "asn"),
            ("source.ip", "ip"),
            ("time.source", "timestamp"),
            ("classification.identifier", "malware"),
            ("source.port", "src_port"),
            ("destination.ip", "dst_ip"),
            ("destination.port", "dst_port"),
            ("destination.fqdn", "dst_host"),
            ("protocol.transport", "proto"))

        format = build_table_format("malware-infected", formats)

        if data_format == "malware-infection_csv_inline":
            # If Inline-Messages are wanted
            substitution_variables["data_location_en"] = substitution_variables["data_location_inline_en"]
            substitution_variables["data_location_de"] = substitution_variables["data_location_inline_de"]
            return context.mail_format_as_csv(format,substitutions=substitution_variables)

        elif data_format == "malware-infection_csv_attachment":
            # TODO There is no attachment, yet!
            substitution_variables["data_location_en"] = substitution_variables["data_location_attached_en"]
            substitution_variables["data_location_de"] = substitution_variables["data_location_attached_de"]
            substitution_variables["data_inline_separator_en"] = ""
            substitution_variables["data_inline_separator_de"] = ""
            return context.mail_format_as_csv(format, substitutions=substitution_variables,
                                              attach_event_data=True)

    return None
