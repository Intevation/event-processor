<meta charset="UTF-8">
<!--
This is a vuejs.org v2 application.
See below for needed javascript libraries.
Also needs a modern browser (that implements the promise interface).


Copyright (C) 2016 by Bundesamt fÃ¼r Sicherheit in der Informationstechnik
Software engineering by Intevation GmbH

This program is Free Software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

Author(s):
    Bernhard E. Reiter <bernhard@intevation.de>
-->


<!--
curl -O https://vuejs.org/js/vue.js
head -2 vue.js | tail -1
# * Vue.js v2.0.5
sha256sum vue.js ; \
echo 045aa148655b5d8083a86c6595bccd594371b26b7324d8f9cbe01af438fff405
-->
<script src="./vue.js" type="text/javascript"></script>
<!--
curl -O https://cdn.jsdelivr.net/vue.resource/1.0.3/vue-resource.min.js
sha256sum vue-resource.min.js \
echo af5a73780d4b0913d00fda1eb8d0cfe13f1fb72b6aef06928259a621209f13d2
-->
<script src="./vue-resource.min.js" type="text/javascript"></script>

<!--
curl -O https://cdn.jsdelivr.net/semantic-ui/2.2.6/semantic.min.css
sha256sum semantic.min.css \
echo 88aec064ced76b8da2b9445d31da35b29dfc95dfc92777c3b52d39db718aa9d9
-->
<link rel="stylesheet" href="./semantic.min.css">

<h1>Checking an intelmq CERT-Bund Ticket</h1>
<div id="checkticket">
  Ticket#
  <input
    v-model:title="ticketID"
    v-on:keyup.enter="lookupIDs"
    placeholder="20161020-10000004"
  >
  <button v-on:click="lookupIDs">go</button>


  <p v-if="eventIDs.length === 0">
    Not found.
  </p>

  <p v-if="eventIDs.length > 0">
  Event IDs:
  <span>{{ eventIDs }}
  <button v-on:click="loadDetails">details</button>
  </span>
  </br>

  <table
      class="ui celled very compact striped table" 
      v-if="eventIDs.length > 0"
  >
    <tr>
    <th v-for='column in Object.keys(events[0])' v-if='column !== "raw"'>
      {{ column }}
    </th>
    <tr v-for='event in events'>
      <td v-for="field in Object.keys(events[0])" v-if='column !== "raw"'>
      {{ event[field] }}
      </td>
    </tr>
    </table>
  </p>

</div>

<script type="text/javascript">
'use strict';

function log(text) {
   var logElement = document.getElementById('log');
   console.log(text);
}

var ticketid = new Vue({
  el: '#checkticket',
  data: {
    queryURL: 'http://localhost:8000/',  // base url for checkticket.py service
    ticketID: '20161020-10000004',  // TODO remove example
    eventIDs: [],  // list of corresponding ids for the ticket
    events: []  // list of events details
  },
  methods: {
    lookupIDs : function () {
      var url = this.queryURL + '/getEventIDsForTicket?ticket=' + this.ticketID;
      this.$http.get(url).then((response) => {
        response.json().then((value) => {
      if(value) {
        this.eventIDs = value;
        this.events = [];
        // directly load events, if we only have a few
        if (this.eventIDs.length < 50) {
            console.log("less than 50 events, triggering loading directly");
            this.loadDetails();
        }
      } else {
        this.eventIDs = [];
        this.events = [];
      }
    });
      }, (response) => {
        this.eventIDs = []
    this.events = [];
      });
    },
    loadDetails : function () {
      var url = this.queryURL + '/getEvents?';
      for(var i = 0, size = this.eventIDs.length; i < size ; i++){
        url += 'ids=' + this.eventIDs[i] + '&';
      }
      log('Trying to load ' + url);

      this.$http.get(url).then((response) => {
        // success
    log('Result: ' + response.body);
    response.json().then((value) => {
      this.events = value;
    });
      }, (response) => {
        // failure
        this.events = []
      });
    }
  }
})
</script>
